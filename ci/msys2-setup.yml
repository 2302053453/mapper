# This file is part of OpenOrienteering.

# Copyright 2019 Kai Pastor
#
# Redistribution and use is allowed according to the terms of the BSD license:
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 
# 1. Redistributions of source code must retain the copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
# 3. The name of the author may not be used to endorse or promote products 
#    derived from this software without specific prior written permission.
# 
# THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
# IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
# OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
# IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
# INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
# NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
# DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
# THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
# THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

jobs:
- job: MSYS2_Setup

  strategy:
    matrix:
      mingw32:
        mingw: 'mingw32'
        arch:  'i686'
      mingw64:
        mingw: 'mingw64'
        arch:  'x86_64'

  pool:
    vmImage: 'windows-2019'

  steps:
  - task: DownloadPipelineArtifact@0
    inputs:
      pipelineId: $(msys2.reuseBuildId)
      artifactName: 'msys2-$(mingw)'
    displayName: 'Download MSYS2 artifact'
    condition: ne('', variables['msys2.reuseBuildId'])

  - task: ExtractFiles@1
    inputs:
      archiveFilePatterns: msys2.tgz
      destinationFolder: C:\
      cleanDestinationFolder: false
    displayName: 'Extract MSYS2 artifact'
    condition: ne('', variables['msys2.reuseBuildId'])

  - script: |
      choco install msys2 --params="/InstallDir:C:\msys2 /NoUpdate /NoPath"
    displayName: 'Install MSYS2'
    condition: eq('', variables['msys2.reuseBuildId'])

  - script: |
      set PATH=C:\msys2\usr\bin;%WINDIR%\system32;%WINDIR%;%WINDIR%\system32\wbem
      C:\msys2\usr\bin\pacman --noconfirm -Syyuu 2>error.log
      if errorlevel 1 (
        type error.log 1>&2
        exit /b 1
      ) else (
        type error.log
      )
      C:\msys2\usr\bin\pacman --noconfirm -Syuu
    displayName: 'Update MSYS2'

  - script: |
      set PATH=C:\msys2\usr\bin;%WINDIR%\system32;%WINDIR%;%WINDIR%\system32\wbem
      C:\msys2\usr\bin\pacman --noconfirm -S --needed ^
        mingw-w64-%ARCH%-binutils ^
        mingw-w64-%ARCH%-cmake ^
        mingw-w64-%ARCH%-doxygen ^
        mingw-w64-%ARCH%-gcc ^
        mingw-w64-%ARCH%-gdal ^
        mingw-w64-%ARCH%-headers-git ^
        mingw-w64-%ARCH%-make ^
        mingw-w64-%ARCH%-ninja ^
        mingw-w64-%ARCH%-proj ^
        mingw-w64-%ARCH%-qt5 ^
        mingw-w64-%ARCH%-tools-git  ^
        mingw-w64-%ARCH%-winpthreads-git ^
        2>error.log
      if errorlevel 1 (
        type error.log 1>&2
        exit /b 1
      ) else (
        type error.log
      )
      @REM 'null' is in the way when extracting the required datumgrid data
      del /F C:\msys2\$(mingw)\share\proj\null
    displayName: 'Install MSYS2 MinGW packages for OpenOrienteering Mapper'

  - bash: |
      set -e
      cd /c/msys2/$(mingw)/share/proj
      curl -L -o proj-datumgrid.tar.gz \
        https://github.com/OSGeo/proj-datumgrid/releases/download/1.8/proj-datumgrid-1.8.tar.gz
      tar xvzf proj-datumgrid.tar.gz --overwrite
      rm proj-datumgrid.tar.gz
    workingDirectory: $(Build.SourcesDirectory)
    displayName: 'Download and install proj-datumgrid'
    condition: eq('', variables['msys2.reuseBuildId'])

  - script: |
      set PATH=C:\msys2\usr\bin;%WINDIR%\system32;%WINDIR%;%WINDIR%\system32\wbem
      echo ON
      C:\msys2\usr\bin\pacman --noconfirm -Scc
      rmdir /S /Q C:\msys2\usr\share\doc\openssl\html
      rmdir /S /Q C:\msys2\$(mingw)\share\doc\gettext\examples
      rmdir /S /Q C:\msys2\$(mingw)\share\doc\libxml2-2.9.9\html
      rmdir /S /Q C:\msys2\$(mingw)\share\doc\libxml2-python-2.9.9\examples
      rmdir /S /Q C:\msys2\$(mingw)\share\doc\libxslt-1.1.33\html
      rmdir /S /Q C:\msys2\$(mingw)\share\doc\JasPer\html
      rmdir /S /Q C:\msys2\$(mingw)\share\doc\openssl\html
      rmdir /S /Q C:\msys2\$(mingw)\share\doc\xapian-core\apidoc\html
      rmdir /S /Q C:\msys2\$(mingw)\share\gtk-doc\html
      rmdir /S /Q C:\msys2\$(mingw)\share\qt5\examples
      @REM The debug information takes much space but we must not delete the DLLs.
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt53DAnimationd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt53DCored.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt53DExtrasd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt53DInputd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt53DLogicd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt53DQuickAnimationd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt53DQuickd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt53DQuickExtrasd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt53DQuickInputd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt53DQuickRenderd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt53DQuickScene2Dd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt53DRenderd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5Bluetoothd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5Chartsd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5Concurrentd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5Cored.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5DataVisualizationd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5DBusd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5DesignerComponentsd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5Designerd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5Gamepadd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5Guid.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5Helpd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5Locationd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5Multimediad.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5MultimediaQuickd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5MultimediaWidgetsd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5NetworkAuthd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5Networkd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5Nfcd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5OpenGLd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5Positioningd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5PositioningQuickd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5PrintSupportd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5Purchasingd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5Qmld.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5QuickControls2d.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5Quickd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5QuickParticlesd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5QuickShapesd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5QuickTemplates2d.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5QuickTestd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5QuickWidgetsd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5RemoteObjectsd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5Scriptd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5ScriptToolsd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5Scxmld.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5Sensorsd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5SerialBusd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5SerialPortd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5Sqld.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5Svgd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5Testd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5TextToSpeechd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5VirtualKeyboardd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5WebChanneld.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5WebSocketsd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5WebViewd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5Widgetsd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5WinExtrasd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5Xmld.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\bin\Qt5XmlPatternsd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\virtualkeyboard\qtvirtualkeyboard_hanguld.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\virtualkeyboard\qtvirtualkeyboard_openwnnd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\virtualkeyboard\qtvirtualkeyboard_pinyind.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\virtualkeyboard\qtvirtualkeyboard_tcimed.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\virtualkeyboard\qtvirtualkeyboard_thaid.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\texttospeech\qtexttospeech_sapid.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\styles\qwindowsvistastyled.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\sqldrivers\qsqlibased.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\sqldrivers\qsqlited.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\sqldrivers\qsqlmysqld.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\sqldrivers\qsqlodbcd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\sqldrivers\qsqlpsqld.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\sensors\qtsensors_genericd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\sensorgestures\qtsensorgestures_counterplugind.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\sensorgestures\qtsensorgestures_plugind.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\sensorgestures\qtsensorgestures_shakeplugind.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\sceneparsers\assimpsceneimportd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\sceneparsers\gltfsceneexportd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\sceneparsers\gltfsceneimportd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\renderplugins\scene2dd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\qmltooling\qmldbg_debuggerd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\qmltooling\qmldbg_inspectord.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\qmltooling\qmldbg_locald.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\qmltooling\qmldbg_messagesd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\qmltooling\qmldbg_natived.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\qmltooling\qmldbg_nativedebuggerd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\qmltooling\qmldbg_previewd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\qmltooling\qmldbg_profilerd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\qmltooling\qmldbg_quickprofilerd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\qmltooling\qmldbg_serverd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\qmltooling\qmldbg_tcpd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\printsupport\windowsprintersupportd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\position\qtposition_positionpolld.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\position\qtposition_serialnmead.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\playlistformats\qtmultimedia_m3ud.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\platforms\qdirect2dd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\platforms\qminimald.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\platforms\qoffscreend.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\platforms\qwebgld.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\platforms\qwindowsd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\platforminputcontexts\qtvirtualkeyboardplugind.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\mediaservice\dsengined.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\mediaservice\qtmedia_audioengined.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\imageformats\qgifd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\imageformats\qicnsd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\imageformats\qicod.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\imageformats\qjp2d.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\imageformats\qjpegd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\imageformats\qsvgd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\imageformats\qtgad.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\imageformats\qtiffd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\imageformats\qwbmpd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\imageformats\qwebpd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\iconengines\qsvgicond.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\geoservices\qtgeoservices_esrid.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\geoservices\qtgeoservices_itemsoverlayd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\geoservices\qtgeoservices_mapboxd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\geoservices\qtgeoservices_nokiad.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\geoservices\qtgeoservices_osmd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\geometryloaders\defaultgeometryloaderd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\geometryloaders\gltfgeometryloaderd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\generic\qtuiotouchplugind.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\gamepads\sdl2gamepad.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\gamepads\xinputgamepad.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\designer\containerextensiond.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\designer\customwidgetplugind.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\designer\taskmenuextensiond.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\designer\worldtimeclockplugind.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\canbus\qtpassthrucanbusd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\canbus\qtpeakcanbusd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\canbus\qtsysteccanbusd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\canbus\qttinycanbusd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\canbus\qtvectorcanbusd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\canbus\qtvirtualcanbusd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\bearer\qgenericbearerd.dll
      C:\msys2\$(mingw)\bin\strip --strip-unneeded C:\msys2\$(mingw)\share\qt5\plugins\audio\qtaudio_windowsd.dll
      exit /b 0
    displayName: 'Reduce installation size for CI'

  - script: |
      set PATH=C:\msys2\usr\bin;%WINDIR%\system32;%WINDIR%;%WINDIR%\system32\wbem
      mkdir $(Build.SourcesDirectory)\output
      C:
      cd \
      tar czf $(Build.SourcesDirectory)\output\msys2.tgz msys2
      if not errorlevel 1 (
        find msys2
      )
    displayName: 'Prepare pipeline artifact'

  - task: PublishPipelineArtifact@0
    inputs:
      artifactName: 'msys2-$(mingw)'
      targetPath: $(Build.SourcesDirectory)\output
    displayName: 'Publish binary artifacts'

